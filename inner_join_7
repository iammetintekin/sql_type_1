-- URUNLERIN FIYAT ANALIZI
SELECT ITM.ITEMCODE AS URUNKODU, ITM.ITEMNAME AS URUNADI,
MIN(OD.UNITPRICE) AS ENDUSUKFIYAT,
MAX(OD.UNITPRICE) AS ENYUKSEKFIYAT,
AVG(OD.UNITPRICE) AS ORTALAMAFIYAT,
SUM(OD.AMOUNT) AS TOPLAMADET
FROM ORDERS O
INNER JOIN USERS U ON U.ID=O.USERID
INNER JOIN ADDRESS A ON A.ID=O.ADDRESSID
INNER JOIN CITIES CT ON CT.ID = A.CITYID
INNER JOIN TOWNS T ON T.ID = A.TOWNID
INNER JOIN DISTRICTS D ON D.ID = A.DISTRICTID
INNER JOIN PAYMENTS P ON P.ORDERID = O.ID
INNER JOIN INVOICES I ON I.ORDERID = O.ID
INNER JOIN ORDERDETAILS OD ON OD.ORDERID = O.ID
INNER JOIN ITEMS ITM ON ITM.ID = OD.ITEMID
GROUP BY ITM.ITEMCODE, ITM.ITEMNAME



-- EN COK HANGI AYDA SATILDIGINI BULMA
SELECT 
ITM.ITEMCODE AS URUNKODU,
ITM.ITEMNAME AS URUNADI,
(SELECT MIN(ORDERDETAILS.UNITPRICE) FROM ORDERDETAILS WHERE ITEMID = ITM.ID) AS ENDUSUKFIYAT,
(SELECT MAX(ORDERDETAILS.UNITPRICE) FROM ORDERDETAILS WHERE ITEMID = ITM.ID) AS ENYUKSEKFIYAT,
(SELECT AVG(ORDERDETAILS.UNITPRICE) FROM ORDERDETAILS WHERE ITEMID = ITM.ID) AS ORTALAMAFIYAT,
(SELECT SUM(ORDERDETAILS.AMOUNT) FROM ORDERDETAILS WHERE ITEMID = ITM.ID) AS TOPLAMADET,
(
	SELECT TOP 1 DATEPART(MONTH, o.DATE_) AS AY
	from ORDERDETAILS OD
	INNER JOIN ORDERS O ON OD.ORDERID = O.ID
	WHERE OD.ITEMID = ITM.ID
	GROUP BY DATEPART(MONTH,O.DATE_)
) as ENCOKSATILANAY
FROM ITEMS ITM
ORDER BY ITM.ITEMNAME
